# Tutorial for the EvalRS 2023 - RecSys evaluation hackaton

## Retrieval models with Merlin and Tensorflow on LastFM/EvalRS dataset

This tutorial demonstrates how you can build and train retrieval models with [Merlin framework](https://github.com/NVIDIA-Merlin/) and Tensorflow. It builds, trains and evaluates two retrieval models: **Matrix Factorization** and **Two-Tower architecture**.  

You can run it on Colab!  [![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/drive/1Ftl2B7BVFMfFjyjWweFCP_gA_LdCl7-a?usp=sharing)

## Running the tutorial in your environment

If you have an environment with Linux, GPU (with at least 16 GB memory) and Docker, you can run this tutorial in your environment using the full EvalRS dataset.
You have two options for getting results for evaluation:
- (A) To build, train (and improve) the model
- (B) Take the baseline predictions from model (A) and focus on the evaluation / model analysis

### (A) Setup for training the models
For easier setup we recommend using Docker.

1. Run the following command pulls and run the Merlin TensorFlow Container (23.06 release).  
Please set the host path to the folder where you have pulled the `evalRS-KDD-2023` repo from GitHub and also the path where the dataset will be downloaded and preprocessed.

```bash
docker run --runtime=nvidia --rm -it --ipc=host --cap-add SYS_NICE -v /PATH/TO/evalRS-KDD-2023:/evalRS-KDD-2023 -v /PATH/TO/DATASET/WORKSPACE:/data -p 8888:8888 nvcr.io/nvidia/merlin/merlin-tensorflow:23.06 /bin/bash
```

2. Inside the Docker container, pull the [RecList](https://github.com/RecList/reclist) library and install it. RecList will be used for evaluation.

```bash
mkdir -p /workspace/ && cd /workspace/
git clone https://github.com/Reclist/reclist/
cd reclist && pip install -e .
```

3. Also inside the Docker container, update the [Models](https://github.com/NVIDIA-Merlin/models/) library to the [evalRS_2023](https://github.com/NVIDIA-Merlin/models/tree/evalrs_2023), which has some fixes necessary for pre-trained embeddings support.

```bash
cd /models
git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*" && git fetch origin evalRS_2023 && git checkout evalRS_2023
pip install . --no-deps
```

4. Start Jupyter notebook inside the container

```bash
cd /evalRS-KDD-2023/notebooks/merlin_tf_tutorial
jupyter notebook --no-browser --ip 0.0.0.0 --no-browser --allow-root
```

5. Load the Jupyter notebook UI in a web browser. Look for the URL provided in the console, that contains the token. Something like `http://127.0.0.1:8888/?token=5ac3f9ca...`

6. Run the [Merlin tutorial notebook](evalrs_kdd_2023_tutorial_retrieval_models_with_merlin_tf.ipynb)


### (B) Evaluation based on saved recommendations

For your convenience, we have already trained retrieval models in (A) on a V100 GPU and saved the predictions.

1. Download the [model prediction parquet files](https://drive.google.com/file/d/13cMNDLmdXppUl8cOOO_Bs28-qOxzK5sY/view?usp=sharing), which we have generated by running the above notebook in a V100 GPU.

2. Run this [Jupyter notebook](evalrs_kdd_2023_reclist_eval_on_saved_preds.ipynb) to evaluate with **RecList** on the predictions generated by some trained Merlin retrieval models.

